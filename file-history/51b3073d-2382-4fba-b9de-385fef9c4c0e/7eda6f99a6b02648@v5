# Insurance Project Memory

**Architecture**: Link Farm + Hub-and-Spoke with Progressive Disclosure

**Purpose**: Personal insurance automation and credential management

**Documentation Hub**: [`docs/INDEX.md`](/Users/terryli/own/insurance/docs/INDEX.md)

---

## Quick Links

**Automation**: [`docs/automation/manulife-par.md`](/Users/terryli/own/insurance/docs/automation/manulife-par.md) - Playwright form workflows
**Specifications**: [`specifications/`](/Users/terryli/own/insurance/specifications/) - OpenAPI 3.1.0 specs
**SLOs**: [`specifications/slo.yaml`](/Users/terryli/own/insurance/specifications/slo.yaml) - Service level objectives
**Audit**: [`docs/AUDIT.md`](/Users/terryli/own/insurance/docs/AUDIT.md) - API verification (v1.1.0, 2025-10-16)
**Scripts**: [`scripts/playwright/`](/Users/terryli/own/insurance/scripts/playwright/) - Executable automation

---

## Credential Management

**Doppler Project**: `insurance` (production config: `prd`)

**Access Pattern**:
```bash
doppler run --project insurance --config prd -- <command>
```

**View Secrets**:
```bash
doppler secrets --project insurance --config prd
```

**Current Credentials**:
- Manulife Par Account (`MANULIFE_PAR_*`)

**Migration Workflow**: [`docs/workflows/credential-sync.md`](/Users/terryli/own/insurance/docs/workflows/credential-sync.md)

---

## Playwright Automation

**Framework**: Playwright (Python) with `uv`
**Authentication**: Passkey via `storage-state.json` (gitignored)
**Artifacts**: Screenshots, DOM dumps, HAR, trace, telemetry (no video)

**Key Features**:
- **PII-safe**: Masked screenshots, log keys only
- **ARIA-first selectors**: Stable, accessibility-driven targeting
- **Comprehensive capture**: HAR, trace with snapshots, telemetry NDJSON
- **Iframe-proof**: Automatic frame detection
- **Offline replay**: `routeFromHAR` for analysis

**Usage**:
```bash
export FORM_JSON='{"first_name":"Ada",...}'
doppler run --project insurance --config prd -- \
  uv run --active python -m scripts.playwright.fill_par_form
```

**Documentation**: [`docs/automation/manulife-par.md`](/Users/terryli/own/insurance/docs/automation/manulife-par.md)
**Specification**: [`specifications/playwright-automation.yaml`](/Users/terryli/own/insurance/specifications/playwright-automation.yaml)

---

## AI Agent Brief

For any AI coding agent implementing form automation:

> **Environment**: Python + Playwright, auth via `storage-state.json`, secrets via Doppler
> **Input**: JSON payload in `FORM_JSON` env var
> **Artifacts**: Screenshots (PII-masked), DOM dumps, HAR, trace, telemetry NDJSON
> **No video recording**
> **Implementation**: ARIA-first selectors, iframe detection, bounded retries
> **Output**: `artifacts/YYYY-MM-DD_HH-MM-SS/` with `index.json` manifest

**Full specification**: [`specifications/manulife-par-form.yaml`](/Users/terryli/own/insurance/specifications/manulife-par-form.yaml)

---

## Development Standards

**Python**: `uv run --active python -m <module>`
**Versioning**: SemVer 2.0.0
**Paths**: Always absolute (`/Users/terryli/...`), space after extension
**Security**: Doppler injection only, never commit secrets
**Machine-Readable**: OpenAPI 3.1.0 specs prioritized over human docs

---

## Project Structure

```
~/own/insurance/
├── CLAUDE.md                           # This file (project hub)
├── .gitignore                          # Excludes secrets, artifacts, auth state
├── docs/                               # Documentation
│   ├── INDEX.md                       # Documentation hub
│   ├── automation/                    # Playwright automation docs
│   │   └── manulife-par.md           # Manulife Par form workflow
│   └── workflows/                     # Operational workflows
│       └── credential-sync.md        # 1Password → Doppler migration
├── specifications/                     # Machine-readable specs
│   ├── playwright-automation.yaml    # Universal automation spec (OpenAPI 3.1.0)
│   └── manulife-par-form.yaml       # Manulife Par form mappings
├── scripts/                           # Executable scripts
│   └── playwright/                   # Playwright automation
│       └── fill_par_form.py         # [TODO] Main form-filling script
├── artifacts/                         # Generated artifacts (gitignored)
│   └── .gitkeep
└── storage-state.json                 # Playwright auth state (gitignored)
```

---

## Playwright Enhancement Checklist

From GPT-5 research, implemented in specifications:

- [x] **Tracing**: screenshots + DOM snapshots enabled
- [x] **HAR recording**: Context-level network capture via Browser.new_context()
- [x] **PII-safe screenshots**: Mask sensitive fields
- [x] **ARIA-first selectors**: getByLabel/Role/Placeholder priority
- [x] **ARIA snapshots**: YAML accessibility tree via Locator.aria_snapshot()
- [x] **Iframe handling**: FrameLocator for nested forms
- [x] **Network telemetry**: request/response/failed events logged
- [x] **Console capture**: JS errors and logs streamed to NDJSON
- [x] **Offline replay**: routeFromHAR for analysis
- [x] **File upload support**: setInputFiles for PDF/documents
- [x] **No video recording**: Performance/PII concerns

**Reference**: [`specifications/playwright-automation.yaml`](/Users/terryli/own/insurance/specifications/playwright-automation.yaml) `x-implementation-requirements` section

---

## Global Resources

**Parent Config**: [`~/.claude/CLAUDE.md`](/Users/terryli/.claude/CLAUDE.md)
**Doppler Integration**: [`~/.claude/specifications/doppler-integration.yaml`](/Users/terryli/.claude/specifications/doppler-integration.yaml)
**Toolchain**: [`~/.claude/docs/setup/toolchain.md`](/Users/terryli/.claude/docs/setup/toolchain.md)
**Credential Management**: [`~/.claude/docs/setup/credential-management.md`](/Users/terryli/.claude/docs/setup/credential-management.md)
