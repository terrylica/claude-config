name: Enforce Production Code Only (ZERO-TRUST WHITELIST)

on:
  pull_request:
    branches:
      - main

jobs:
  validate-whitelist:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Enforce zero-trust whitelist
        run: |
          set -e

          echo "ğŸ”’ ZERO-TRUST WHITELIST: Nothing merges to main unless explicitly approved"
          echo "========================================================================"

          # Get all files changed in this PR
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD)

          if [ -z "$CHANGED_FILES" ]; then
            echo "âœ… No files changed in PR"
            exit 0
          fi

          echo "ğŸ“„ Files attempting to merge:"
          echo "$CHANGED_FILES" | sed 's/^/  - /'
          echo ""

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # WHITELIST: Add patterns here when explicitly approved
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # Format: One regex pattern per line
          # Example: '^ml_feature_set/bundled/.*\.py$'
          #
          # CURRENT POLICY: EMPTY = BLOCK EVERYTHING
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          WHITELIST_PATTERNS=(
            # TODO: Add approved file patterns here
            # NO PATTERNS = ZERO FILES ALLOWED
          )

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          # Check each changed file against whitelist
          BLOCKED_FILES=()

          while IFS= read -r file; do
            matched=false

            # If whitelist is empty, nothing is allowed
            if [ ${#WHITELIST_PATTERNS[@]} -eq 0 ]; then
              BLOCKED_FILES+=("$file")
              continue
            fi

            # Check if file matches any approved pattern
            for pattern in "${WHITELIST_PATTERNS[@]}"; do
              # Skip empty lines and comments
              if [[ -z "$pattern" ]] || [[ "$pattern" =~ ^[[:space:]]*# ]]; then
                continue
              fi

              if echo "$file" | grep -qE "$pattern"; then
                matched=true
                break
              fi
            done

            # If no match found, file is BLOCKED
            if [ "$matched" = false ]; then
              BLOCKED_FILES+=("$file")
            fi
          done <<< "$CHANGED_FILES"

          # Report results
          if [ ${#BLOCKED_FILES[@]} -eq 0 ]; then
            echo "âœ… SUCCESS: All files are in the approved whitelist"
            echo ""
            echo "All changed files have been explicitly approved for main branch."
            exit 0
          else
            echo "âŒ FAILURE: Unapproved files detected in PR"
            echo ""
            echo "The following files are NOT in the whitelist:"
            printf '  âŒ %s\n' "${BLOCKED_FILES[@]}"
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ”’ ZERO-TRUST WHITELIST POLICY"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "ğŸ“‹ Current whitelist status:"

            if [ ${#WHITELIST_PATTERNS[@]} -eq 0 ]; then
              echo "  â›” EMPTY WHITELIST - Nothing is approved for main branch"
            else
              echo "  âœ… Approved patterns:"
              printf '     â€¢ %s\n' "${WHITELIST_PATTERNS[@]}" | grep -v "^[[:space:]]*#" | grep -v "^[[:space:]]*$"
            fi

            echo ""
            echo "ğŸ’¡ To approve files for main branch:"
            echo "  1. Review the files in this PR carefully"
            echo "  2. If approved, add pattern to whitelist in:"
            echo "     .github/workflows/enforce-production-only.yml"
            echo "  3. Commit whitelist update to main branch first"
            echo "  4. Then rebase/update this PR"
            echo ""
            echo "Example patterns to add:"
            echo "  '^ml_feature_set/bundled/.*\.py$'     # Allow Python files in bundled/"
            echo "  '^pyproject\.toml$'                    # Allow pyproject.toml"
            echo "  '^README\.md$'                         # Allow root README only"
            echo ""
            echo "âš ï¸  Default policy: BLOCK EVERYTHING unless explicitly approved"
            echo ""
            exit 1
          fi
