# AWS Credential Elimination Plan

**Version**: 1.1.0
**Status**: Ready for Final Cleanup (4/5 complete)
**Created**: 2025-10-10
**Last Updated**: 2025-10-10

## Objective

Eliminate all plain-text AWS credentials from local files and migrate to Doppler-managed secure credential storage.

## SLOs

### Availability
- **Target**: 100% - All AWS CodeArtifact authentication flows functional
- **Measurement**: Script execution success rate
- **Validation**: `doppler run --project aws-credentials --config dev -- aws sts get-caller-identity`

### Correctness
- **Target**: 100% - Zero credential leaks, all secrets loaded from Doppler
- **Measurement**: `grep -r "AKIAQXMIDFANLGRPPGUJ" ~/.local-configs ~/eon/ml-feature-experiments` returns no matches (excluding this plan)
- **Validation**: All authentication succeeds with Doppler-loaded credentials only

### Observability
- **Target**: Complete audit trail of credential access
- **Measurement**: Doppler activity logs show all credential retrievals
- **Validation**: `doppler activity --project aws-credentials`

### Maintainability
- **Target**: Single source of truth for AWS credentials
- **Measurement**: Credentials exist only in Doppler (aws-credentials/dev)
- **Validation**: Documentation references Doppler as canonical source

## Implementation Status

### ✅ Step 1: Documentation Updates (COMPLETED)
**Files Modified**:
- `/Users/terryli/eon/ml-feature-experiments/CLAUDE.md:13-14` - Updated to reference Doppler workflow
- `/Users/terryli/eon/ml-feature-experiments/CLAUDE.md:103` - Updated AWS CodeArtifact integration section
- `/Users/terryli/eon/ml-feature-experiments/docs/roadmap/lib_tabpfnclassifier.md:471-473` - Updated environment integration

**Validation**: `grep -i "doppler" /Users/terryli/eon/ml-feature-experiments/CLAUDE.md` shows updated references

### ✅ Step 2: Refactor set_env.sh (COMPLETED)
**Primary Script**: `/Users/terryli/eon/ml-feature-experiments/set_env.sh`
- Lines 1-30: Header updated to "Doppler-Managed AWS Credentials"
- Lines 675-732: `setup_codeartifact()` rewritten with Doppler integration
- Lines 63-97: `configure_aws_credentials()` updated for Doppler status
- Lines 1431-1441: Help messages updated
- Line 698: Fixed Doppler format flag (`env-no-names` → `env-no-quotes --no-file`)

**Deprecated Script**: `/Users/terryli/.local-configs/ml-feature-set/set_env.sh`
- Lines 1-8: Header marked as DEPRECATED
- Lines 200-237: `setup_codeartifact()` refactored with Doppler
- Lines 41-46: `configure_aws_credentials()` shows deprecation notice
- Line 178: Fixed Doppler format flag (`env-no-names` → `env-no-quotes --no-file`)

**Validation**: `grep -n "AKIAQXMIDFANLGRPPGUJ" /Users/terryli/eon/ml-feature-experiments/set_env.sh` returns no matches

**Bug Fix (2025-10-10)**: Corrected invalid Doppler format flag
- Issue: `--format env-no-names` is not a valid Doppler format
- Fix: Changed to `--format env-no-quotes --no-file` for stdout output
- Validation: `doppler secrets download --project aws-credentials --config dev --format env-no-quotes --no-file | head -4` successfully outputs credentials

### ✅ Step 3: Test Refactored Workflow (COMPLETED)
**Test Execution** (2025-10-10):

**T1 - Doppler Secret Access**: ✅ PASSED
- Command: `doppler secrets --project aws-credentials --config dev`
- Result: Successfully listed all secrets in aws-credentials/dev project

**T2 - Credential Loading with Exports**: ✅ PASSED
- Command: `eval $(doppler secrets download --project aws-credentials --config dev --format env-no-quotes --no-file | grep -E "^(AWS_ACCESS_KEY_ID|AWS_SECRET_ACCESS_KEY|AWS_DEFAULT_REGION|AWS_ACCOUNT_ID)=")`
- Result: Credentials loaded and exported successfully
- Verified: AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, AWS_DEFAULT_REGION, AWS_ACCOUNT_ID

**T3 - AWS CLI Authentication**: ✅ PASSED
- Command: `aws sts get-caller-identity`
- Result: Authenticated as arn:aws:iam::050214414362:user/terryli
- Account: 050214414362

**T3b - CodeArtifact Authorization**: ✅ PASSED
- Command: `aws codeartifact get-authorization-token --domain eonlabs`
- Result: Authorization token obtained (1222 characters)
- Domain: eonlabs, Account: 050214414362, Region: us-west-2

**Issues Resolved**:
1. **Invalid Doppler Format**: Fixed `env-no-names` → `env-no-quotes --no-file`
2. **Large JSON Breaking eval**: Added grep filter to exclude AWS_ACCESS_INVENTORY_REPORT and AWS_ACCESS_SUMMARY
3. **Missing Exports**: Added explicit export statements after eval to ensure AWS CLI can access credentials

**Validation**: All authentication flows functional, zero hardcoded credentials used

### ✅ Step 4: Update ~/.aws/credentials (COMPLETED)
**Action**: Added comprehensive deprecation notice to ~/.aws/credentials
**Location**: `/Users/terryli/.aws/credentials`

**Changes Made** (2025-10-10):
- Added 29-line deprecation header with security benefits and usage instructions
- Documented credential rotation: AKIAQXMIDFANLGRPPGUJ → AKIAQXMIDFANMPSY7LFK
- Marked [el-dev] profile as DEPRECATED with "DO NOT USE" warning
- Preserved old credentials for reference and emergency rollback
- Scheduled old IAM key for deletion after 2025-11-10

**Key Information Included**:
- Doppler location: `doppler://aws-credentials/dev`
- Usage instructions for both `doppler run` and `source set_env.sh`
- Security benefits: centralized management, audit trail, rotation support
- Clear deprecation warnings throughout

**Validation**: ✅ File updated, deprecation notice in place

### ⏳ Step 5: Final Cleanup (PENDING)
**Actions**:
1. Delete old AWS IAM key: `aws iam delete-access-key --access-key-id AKIAQXMIDFANLGRPPGUJ --user-name terryli`
2. Update Doppler notes: Mark AWS_ACCESS_KEY_ID_OLD as "AWS IAM key deleted"
3. Archive ~/.aws/credentials: `mv ~/.aws/credentials ~/.aws/credentials.deprecated.2025-10-10`

**Prerequisites**: Step 3 validation passes, user approval

## Credential Inventory

### Sources Eliminated
| Location | Type | Status | Old Key |
|----------|------|--------|---------|
| `~/eon/ml-feature-experiments/set_env.sh:668-669` | Hardcoded | ✅ Removed | AKIAQXMIDFANLGRPPGUJ |
| `~/.local-configs/ml-feature-set/set_env.sh:210-211` | Hardcoded | ✅ Removed | AKIAQXMIDFANLGRPPGUJ |
| `~/.aws/credentials:2-3` | File | ⏳ Deprecation notice pending | AKIAQXMIDFANLGRPPGUJ |
| `~/.zsh_history` | History | ⏳ Cleanup pending | AKIAQXMIDFANLGRPPGUJ |

### Doppler Storage (Canonical Source)
| Secret | Value | Status | Notes |
|--------|-------|--------|-------|
| AWS_ACCESS_KEY_ID | AKIAQXMIDFANMPSY7LFK | Active | New credential (never exposed) |
| AWS_SECRET_ACCESS_KEY | [secure] | Active | New credential (never exposed) |
| AWS_ACCESS_KEY_ID_OLD | AKIAQXMIDFANLGRPPGUJ | Archived | Old credential (exposed, awaiting deletion) |
| AWS_SECRET_ACCESS_KEY_OLD | [secure] | Archived | Old credential (exposed, awaiting deletion) |
| AWS_DEFAULT_REGION | us-west-2 | Active | Primary region |
| AWS_ACCOUNT_ID | 050214414362 | Active | EonLabs account |

## Dependencies

### Required Tools
- Doppler CLI: `doppler --version` >= 3.0.0
- AWS CLI: `aws --version` >= 2.0.0
- Python: `python --version` >= 3.10

### Doppler Configuration
- Project: `aws-credentials`
- Config: `dev`
- Authentication: `doppler login` (completed)

## References

### Documentation
- Primary: `/Users/terryli/.claude/docs/setup/aws-credentials-doppler.md`
- Specification: `/Users/terryli/.claude/specifications/aws-credentials-management.yaml`
- User Memory: `/Users/terryli/.claude/CLAUDE.md:344-358`

### Related Files
- Primary script: `/Users/terryli/eon/ml-feature-experiments/set_env.sh`
- Deprecated script: `/Users/terryli/.local-configs/ml-feature-set/set_env.sh`
- Project docs: `/Users/terryli/eon/ml-feature-experiments/CLAUDE.md`

## Next Actions

**Current Status**: Steps 1-4 COMPLETED and VERIFIED ✅

**Step 5 - Final Cleanup** (⏳ PENDING USER APPROVAL):

Before proceeding with Step 5, please confirm:
1. ✅ All AWS workflows functional with Doppler credentials
2. ✅ No services relying on ~/.aws/credentials file
3. ✅ Old credential (AKIAQXMIDFANLGRPPGUJ) not needed for rollback

**Commands for Step 5** (execute after approval):
```bash
# 1. Delete old AWS IAM key
aws iam delete-access-key --access-key-id AKIAQXMIDFANLGRPPGUJ --user-name terryli

# 2. Archive ~/.aws/credentials file
mv ~/.aws/credentials ~/.aws/credentials.deprecated.2025-10-10

# 3. Update Doppler notes (optional)
# Mark AWS_ACCESS_KEY_ID_OLD as "AWS IAM key deleted on YYYY-MM-DD"
```

**Rollback Plan** (if needed):
- Old credentials preserved in `~/.aws/credentials.deprecated.2025-10-10`
- Old IAM key can be reactivated if deleted prematurely
- Doppler contains both old and new credentials (AWS_ACCESS_KEY_ID_OLD)

## Version History

- **1.1.0** (2025-10-10): Steps 1-4 completed, tested and verified. Ready for final cleanup (user approval required)
- **1.0.0** (2025-10-10): Initial plan created, Steps 1-2 completed
