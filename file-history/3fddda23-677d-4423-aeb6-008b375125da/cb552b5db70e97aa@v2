#!/bin/bash
# Helper script to add patterns to the zero-trust whitelist
# Usage: .github/scripts/add-to-whitelist.sh "pattern" "description"

set -e

PATTERN="$1"
DESCRIPTION="$2"
WORKFLOW_FILE=".github/workflows/enforce-production-only.yml"

if [ -z "$PATTERN" ]; then
  echo "‚ùå Error: Pattern required"
  echo ""
  echo "Usage: $0 'pattern' 'description'"
  echo ""
  echo "Examples:"
  echo "  $0 '^ml_feature_set/bundled/.*\.py$' 'Python files in bundled/'"
  echo "  $0 '^pyproject\.toml$' 'Project config'"
  echo "  $0 '^README\.md$' 'Root README'"
  echo ""
  exit 1
fi

if [ ! -f "$WORKFLOW_FILE" ]; then
  echo "‚ùå Error: Workflow file not found: $WORKFLOW_FILE"
  exit 1
fi

# Check if pattern already exists
if grep -q "$PATTERN" "$WORKFLOW_FILE"; then
  echo "‚ö†Ô∏è  Pattern already in whitelist: $PATTERN"
  exit 0
fi

# Add pattern to whitelist
# Find the line with "# TODO: Add approved file patterns here"
# Insert the new pattern after it

if [ -n "$DESCRIPTION" ]; then
  NEW_LINE="            '$PATTERN'  # $DESCRIPTION"
else
  NEW_LINE="            '$PATTERN'"
fi

# Use sed to insert after the TODO comment
sed -i.bak "/# TODO: Add approved file patterns here/a\\
$NEW_LINE
" "$WORKFLOW_FILE"

rm -f "$WORKFLOW_FILE.bak"

echo "‚úÖ Pattern added to whitelist:"
echo "   Pattern: $PATTERN"
if [ -n "$DESCRIPTION" ]; then
  echo "   Description: $DESCRIPTION"
fi
echo ""
echo "üìù Next steps:"
echo "   1. Review the change in: $WORKFLOW_FILE"
echo "   2. Commit to main branch"
echo "   3. Update/rebase your PR"
echo ""
