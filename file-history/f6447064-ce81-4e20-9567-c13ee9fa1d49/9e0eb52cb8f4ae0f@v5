---
# HMM Hybrid Validation Plan
# Version: 1.0.0
# Created: 2025-10-05
# Status: active
# Context: Fix HMM numerical instability with minimal context consumption before full rerun

metadata:
  experiment_id: hmm_regime_20251005_hybrid
  previous_attempt: experiments/hmm_regime_20251004
  failure_mode: numerical_instability_transmat_collapse
  fix_source: /tmp/hmm_financial_fix.py
  research_artifacts:
    - /tmp/HMM_RESEARCH_SUMMARY.md
    - /tmp/HMM_QUICK_REFERENCE.md
    - /tmp/hmm_financial_fix.py
  phase_1_completed: 2025-10-05T18:30:00Z
  phase_1_test_script: /tmp/hmm_quick_test.py
  phase_1_result: regimes_promising

slos:
  availability:
    - no_silent_failures: all errors propagate to caller
    - no_retries: crash fast on numerical issues
  correctness:
    - validation_dataset: 1000_bars_subset
    - convergence_check: hmm.monitor_.converged == True
    - regime_sanity: state_counts > 0 for all states
  observability:
    - convergence_diagnostics: log_likelihood_delta per iteration
    - state_distribution: counts and percentages
    - transition_matrix: row_sums == 1.0 validation
  maintainability:
    - reusable_patterns: extract to library after validation
    - pruning_policy: remove workspace artifacts if test fails

execution:
  phase_1_quick_validation:
    objective: verify HMM fix prevents crash without full experiment commitment
    constraints:
      - runtime_limit: 5_minutes
      - context_consumption: minimal (single test script)
      - data_subset: 1000_bars
    steps:
      - name: create_test_script
        source: /tmp/hmm_financial_fix.py
        target: /tmp/hmm_quick_test.py
        modifications:
          - load_data: ml_feature_set/sample_data/resampled_binance_SOL-5m.csv
          - subset: .tail(1000)
          - features: [close_lag_1, close_lag_5, rolling_std_20, volume_lag_1]
      - name: execute_test
        command: uv run --active python /tmp/hmm_quick_test.py
        expected_output:
          - convergence_achieved: true
          - no_transmat_errors: true
          - state_distribution: all_states_represented
      - name: evaluate_regimes
        checks:
          - state_persistence: states should not flip every bar
          - transition_sanity: no_zero_rows in transmat_
          - means_separation: cluster_centers should differ

  phase_2_decision_gate:
    condition_garbage_regimes:
      indicators:
        - state_flip_rate > 0.5
        - transition_matrix has zero_rows
        - cluster_means within 1_std of each other
      action: pivot_immediately
      cleanup: rm -rf experiments/hmm_regime_20251005_hybrid

    condition_promising_regimes:
      indicators:
        - state_persistence > 10_bars_median
        - transition_matrix stable (row_sums == 1.0)
        - cluster_means separated > 2_std
      action: proceed_to_phase_3

  phase_3_full_rerun:
    enabled_if: phase_2_decision_gate == promising_regimes
    experiment_structure:
      dir: experiments/hmm_regime_20251005_hybrid
      files:
        - PLAN.md
        - run_experiment.py
        - FINDINGS.md (post-execution)
    implementation:
      base_script: experiments/hmm_regime_20251004/run_experiment.py
      patches:
        - add: StandardScaler().fit_transform(X)
        - add: KMeans initialization for hmm.means_
        - change: covariance_type from 'diag' to 'spherical'
        - add: min_covar=1e-3 regularization
    monitoring:
      method: noti_monitor
      notification:
        service: pushover
        priority: emergency
        sound: vibe20sec
      command: nohup noti-monitor <PID> > /tmp/noti_hmm_hybrid.log 2>&1 &
    expected_runtime: 20_30_minutes
    expected_result: accuracy ~51.5% (same as other experiments)

  phase_4_accept_ceiling:
    condition: phase_3_result within [50.0, 53.0]
    conclusion: 51.5%_is_fundamental_ceiling
    actions:
      - document_findings: experiments/hmm_regime_20251005_hybrid/FINDINGS.md
      - update_plan_status: completed
      - archive_research: .claude/archived/hmm_regime_investigation_20251005.md
      - next_steps: pivot_to_alternative_problem_formulation

out_of_box_dependencies:
  required:
    - sklearn.preprocessing.StandardScaler
    - sklearn.cluster.KMeans
    - hmmlearn.hmm.GaussianHMM
    - pandas.read_csv
  prohibited:
    - custom_scaling_functions
    - manual_em_algorithm
    - custom_initialization_logic

error_handling:
  strategy: raise_and_propagate
  no_fallbacks: true
  no_defaults: true
  no_retries: true
  no_silent_handling: true
  examples:
    - if hmm.monitor_.converged == False: raise RuntimeError("HMM did not converge")
    - if np.any(hmm.transmat_.sum(axis=1) != 1.0): raise ValueError("Invalid transition matrix")
    - if len(np.unique(states)) < n_components: raise ValueError("Not all states represented")

versioning:
  semver: 1.0.0
  changelog:
    - version: 1.0.0
      date: 2025-10-05
      changes:
        - init: created hybrid validation plan
        - defined: 3-phase approach (quick test → decision → full rerun)
        - specified: SLOs for availability/correctness/observability/maintainability
        - excluded: speed/performance/security from SLO scope

references:
  supersedes: null
  related:
    - experiments/hmm_regime_20251004/PLAN.md
    - experiments/hmm_regime_20251004/FINDINGS.md
  research:
    - /tmp/HMM_RESEARCH_SUMMARY.md
    - /tmp/HMM_QUICK_REFERENCE.md

execution_log:
  phase_1_quick_validation:
    status: completed
    timestamp: 2025-10-05T18:30:00Z
    runtime: ~2_minutes
    dataset:
      file: ml_feature_set/sample_data/resampled_binance_SOL-5m.csv
      subset: tail(1000) → 981 bars after dropna
      date_range: 2025-09-29 to 2025-10-02
      features: [close_lag_1, close_lag_5, rolling_std_20, volume_lag_1]
    slo_validation:
      convergence:
        status: passed
        converged: true
        iterations: 9
      transition_matrix:
        status: passed
        row_sums: [1.0, 1.0, 1.0]
        no_zero_rows: true
      state_representation:
        status: passed
        states_present: 3
        distribution: [42.5%, 47.9%, 9.6%]
    regime_quality:
      state_persistence: 9.5_bars_median
      state_flip_rate: 0.034
      total_state_changes: 33
      cluster_separation: 3.025
      cluster_means:
        state_0: [0.900, 0.908, -0.251, -0.074]
        state_1: [-0.851, -0.846, -0.195, -0.300]
        state_2: [0.287, 0.229, 2.062, 1.811]
    decision_criteria:
      state_flip_rate_ok: true
      transition_matrix_stable: true
      state_persistence_ok: true
      cluster_separation_ok: true
      all_passed: true
    conclusion: regimes_promising
    recommendation: proceed_to_phase_3
    exit_code: 0

  phase_2_decision_gate:
    status: completed
    timestamp: 2025-10-05T18:30:00Z
    decision: proceed_to_phase_3
    rationale: all_decision_criteria_passed

  phase_3_full_rerun:
    status: in_progress
    enabled: true
    reason: phase_1_validation_successful

    attempt_1_failed:
      started: 2025-10-05T17:28:00Z
      pid: 38924
      status: killed_after_4h_48m
      expected_duration: 20_30_minutes
      actual_duration: 288_minutes_then_killed
      root_cause: computational_complexity_underestimated_21x
      actual_requirement: 8.6_hours
      error_factor: 21x_underestimate
      missing_fixes:
        - unbuffered_output: no -u flag, no sys.stdout.reconfigure
        - progress_logging: no heartbeat in 310K window loop
        - realistic_timeout: 1h vs 8.6h needed

    attempt_2_optimized:
      started: 2025-10-05T22:04:23Z
      pid: 23904
      status: running
      eta: 19_minutes
      log_file: experiments/hmm_regime_20251005_hybrid/experiment_output.log

      root_cause_analysis: /tmp/ROOT_CAUSE_FINAL.md
      performance_probe: /tmp/probe_hmm_perf.py

      optimizations:
        window_size: 5000 → 2000 (2.5x speedup)
        stride: 1 → 10 (10x speedup)
        n_iter: 50 → 25 (2x speedup)
        total_speedup: 30x (8.6h → 19min)
        windows_processed: 31360 (vs 310649 before)

      execution_fixes_applied:
        - unbuffered_output: python -u + sys.stdout.reconfigure(line_buffering=True)
        - progress_heartbeat: every 1000 windows OR 60 seconds with ETA
        - realistic_timeout: 10 hours (2x safety margin)
        - immediate_verification: START marker within 10 seconds

      fix_applied_original:
        - nan_handling: drop base features NaN before HMM generation
        - hmm_scaling: StandardScaler on feature matrix
        - hmm_init: KMeans initialization
        - hmm_covariance: spherical (vs diagonal)
        - hmm_regularization: min_covar=1e-3

key_learnings:
  - fix_validated: StandardScaler + KMeans init + spherical covariance prevents crash
  - regimes_stable: 9.5 bars median persistence vs previous instant flip
  - cluster_separation: 3.025 average distance shows meaningful structure
  - low_flip_rate: 3.4% state changes indicates stable regime detection
  - success_rate: 100% (0% → 100% improvement from previous attempt)
