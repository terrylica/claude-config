#!/bin/bash

# MQL5 Headless Compilation Script
# Compiles the fixed Laguerre RSI indicator

export CX_BOTTLE="MetaTrader 5"
export WINEPREFIX="/Users/terryli/Library/Application Support/CrossOver/Bottles/MetaTrader 5"

WINE="/Users/terryli/Applications/CrossOver.app/Contents/SharedSupport/CrossOver/bin/wine"
MT5_PATH="/Users/terryli/Library/Application Support/CrossOver/Bottles/MetaTrader 5/drive_c/Program Files/MetaTrader 5"
INDICATOR="ATR adaptive smoothed Laguerre RSI 2 (extended) - FIXED.mq5"

cd "$MT5_PATH"

echo "=== MQL5 Compilation Attempt ==="
echo "Indicator: $INDICATOR"
echo "Wine: $WINE"
echo "MT5 Path: $MT5_PATH"
echo ""

# Try compilation with MetaEditor64
"$WINE" MetaEditor64.exe \
  /compile:"MQL5\\Indicators\\Custom\\$INDICATOR" \
  /inc:"MQL5" \
  /log 2>&1

RESULT=$?
echo ""
echo "Wine exit code: $RESULT"

# Check if .ex5 file was created
if [ -f "MQL5/Indicators/Custom/ATR adaptive smoothed Laguerre RSI 2 (extended) - FIXED.ex5" ]; then
    echo "✓ Compilation successful - .ex5 file created"
    ls -lh "MQL5/Indicators/Custom/ATR adaptive smoothed Laguerre RSI 2 (extended) - FIXED.ex5"
else
    echo "✗ Compilation may have failed - no .ex5 file found"
    echo ""
    echo "Checking MetaEditor log..."
    tail -20 "$MT5_PATH/logs/metaeditor.log"
fi
