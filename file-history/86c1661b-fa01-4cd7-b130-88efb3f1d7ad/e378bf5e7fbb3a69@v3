#!/usr/bin/env python3
"""
Fetch Touchstone documentation from Notion.

Retrieves and displays documentation from internal Notion pages, including downloading
embedded images and converting to markdown format.

Requires NOTION_API_TOKEN and NOTION_TOUCHSTONE_PAGE_ID environment variables.

Usage:
    # Using Doppler for credential injection
    doppler run --project claude-config --config dev -- python3 util/touchstone/fetch_notion_docs.py

    # Save to file with images (default: images saved to images/ subdirectory)
    doppler run --project claude-config --config dev -- python3 util/touchstone/fetch_notion_docs.py --output touchstone_docs.md

    # Custom images directory
    doppler run --project claude-config --config dev -- python3 util/touchstone/fetch_notion_docs.py --output docs.md --images-dir custom_images/

    # Skip downloading images (use remote URLs)
    doppler run --project claude-config --config dev -- python3 util/touchstone/fetch_notion_docs.py --output docs.md --no-images
"""

import argparse
import json
import os
import sys
import urllib.request
from pathlib import Path
from urllib.parse import urlparse

from notion_client import Client


def get_page_content(notion: Client, page_id: str) -> dict:
    """
    Retrieve page content including metadata and blocks.

    Args:
        notion: Notion client instance
        page_id: Page ID to retrieve

    Returns:
        Dictionary containing page metadata and content blocks
    """
    # Get page metadata
    page = notion.pages.retrieve(page_id=page_id)

    # Get page blocks (content)
    blocks = notion.blocks.children.list(block_id=page_id)

    return {
        "page": page,
        "blocks": blocks,
    }


def download_image(url: str, output_dir: Path, block_id: str) -> str:
    """
    Download an image from a URL and save it locally.

    Args:
        url: Image URL to download
        output_dir: Directory to save the image
        block_id: Notion block ID (used for filename)

    Returns:
        Relative path to the downloaded image
    """
    try:
        # Create output directory if it doesn't exist
        output_dir.mkdir(parents=True, exist_ok=True)

        # Extract file extension from URL
        parsed_url = urlparse(url)
        path = parsed_url.path
        ext = Path(path).suffix or ".png"

        # Generate filename using block ID
        filename = f"{block_id}{ext}"
        filepath = output_dir / filename

        # Download the image
        urllib.request.urlretrieve(url, filepath)

        return str(filepath)
    except Exception as e:
        print(f"Warning: Failed to download image from {url}: {e}", file=sys.stderr)
        return url  # Return original URL as fallback


def blocks_to_markdown(blocks: list, image_dir: Path = None) -> str:
    """
    Convert Notion blocks to Markdown format.

    Args:
        blocks: List of Notion block objects
        image_dir: Optional directory to save downloaded images

    Returns:
        Markdown-formatted string
    """
    markdown_lines = []

    for block in blocks.get("results", []):
        block_type = block.get("type")

        if block_type == "paragraph":
            text = extract_rich_text(block["paragraph"].get("rich_text", []))
            if text:
                markdown_lines.append(text)
                markdown_lines.append("")  # Empty line after paragraph

        elif block_type == "heading_1":
            text = extract_rich_text(block["heading_1"].get("rich_text", []))
            markdown_lines.append(f"# {text}")
            markdown_lines.append("")

        elif block_type == "heading_2":
            text = extract_rich_text(block["heading_2"].get("rich_text", []))
            markdown_lines.append(f"## {text}")
            markdown_lines.append("")

        elif block_type == "heading_3":
            text = extract_rich_text(block["heading_3"].get("rich_text", []))
            markdown_lines.append(f"### {text}")
            markdown_lines.append("")

        elif block_type == "bulleted_list_item":
            text = extract_rich_text(block["bulleted_list_item"].get("rich_text", []))
            markdown_lines.append(f"- {text}")

        elif block_type == "numbered_list_item":
            text = extract_rich_text(block["numbered_list_item"].get("rich_text", []))
            markdown_lines.append(f"1. {text}")

        elif block_type == "code":
            language = block["code"].get("language", "")
            text = extract_rich_text(block["code"].get("rich_text", []))
            markdown_lines.append(f"```{language}")
            markdown_lines.append(text)
            markdown_lines.append("```")
            markdown_lines.append("")

        elif block_type == "quote":
            text = extract_rich_text(block["quote"].get("rich_text", []))
            markdown_lines.append(f"> {text}")
            markdown_lines.append("")

        elif block_type == "divider":
            markdown_lines.append("---")
            markdown_lines.append("")

        elif block_type == "callout":
            text = extract_rich_text(block["callout"].get("rich_text", []))
            icon = block["callout"].get("icon", {})
            emoji = icon.get("emoji", "ℹ️") if icon.get("type") == "emoji" else "ℹ️"
            markdown_lines.append(f"> {emoji} **Note**: {text}")
            markdown_lines.append("")

        elif block_type == "image":
            image_data = block.get("image", {})
            image_type = image_data.get("type")
            block_id = block.get("id", "unknown")

            # Get image URL based on type (external or file)
            if image_type == "external":
                image_url = image_data.get("external", {}).get("url")
            elif image_type == "file":
                image_url = image_data.get("file", {}).get("url")
            else:
                image_url = None

            if image_url:
                # Download image if image_dir is provided
                if image_dir:
                    local_path = download_image(image_url, image_dir, block_id)
                    # Convert to relative path for markdown (just the filename with images/ prefix)
                    relative_path = f"images/{Path(local_path).name}"
                    markdown_lines.append(f"![Image]({relative_path})")
                else:
                    markdown_lines.append(f"![Image]({image_url})")

                # Add caption if available
                caption = image_data.get("caption", [])
                if caption:
                    caption_text = extract_rich_text(caption)
                    markdown_lines.append(f"*{caption_text}*")

                markdown_lines.append("")

    return "\n".join(markdown_lines)


def extract_rich_text(rich_text_array: list) -> str:
    """
    Extract plain text from Notion rich text objects.

    Args:
        rich_text_array: Array of Notion rich text objects

    Returns:
        Concatenated plain text string
    """
    text_parts = []

    for text_obj in rich_text_array:
        content = text_obj.get("plain_text", "")
        annotations = text_obj.get("annotations", {})

        # Apply markdown formatting based on annotations
        if annotations.get("bold"):
            content = f"**{content}**"
        if annotations.get("italic"):
            content = f"*{content}*"
        if annotations.get("code"):
            content = f"`{content}`"
        if annotations.get("strikethrough"):
            content = f"~~{content}~~"

        # Handle links
        if text_obj.get("href"):
            content = f"[{content}]({text_obj['href']})"

        text_parts.append(content)

    return "".join(text_parts)


def get_page_title(page: dict) -> str:
    """
    Extract page title from page metadata.

    Args:
        page: Notion page object

    Returns:
        Page title string
    """
    properties = page.get("properties", {})

    # Try to find title property
    for prop_name, prop_value in properties.items():
        if prop_value.get("type") == "title":
            title_array = prop_value.get("title", [])
            if title_array:
                return extract_rich_text(title_array)

    return "Untitled"


def main():
    parser = argparse.ArgumentParser(
        description="Fetch Touchstone documentation from Notion",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog=__doc__,
    )
    parser.add_argument(
        "--format",
        choices=["markdown", "json"],
        default="markdown",
        help="Output format (default: markdown)",
    )
    parser.add_argument(
        "--output",
        "-o",
        type=Path,
        help="Output file path (default: stdout)",
    )
    parser.add_argument(
        "--page-id",
        help="Override NOTION_TOUCHSTONE_PAGE_ID environment variable",
    )
    parser.add_argument(
        "--images-dir",
        type=Path,
        help="Directory to save downloaded images (default: images/ relative to output file)",
    )
    parser.add_argument(
        "--no-images",
        action="store_true",
        help="Skip downloading images, use remote URLs instead",
    )

    args = parser.parse_args()

    # Get credentials from environment
    api_token = os.getenv("NOTION_API_TOKEN")
    page_id = args.page_id or os.getenv("NOTION_TOUCHSTONE_PAGE_ID")

    if not api_token:
        print("Error: NOTION_API_TOKEN environment variable not set", file=sys.stderr)
        print("Use Doppler: doppler run --project claude-config --config dev -- python3 ...", file=sys.stderr)
        sys.exit(1)

    if not page_id:
        print("Error: NOTION_TOUCHSTONE_PAGE_ID environment variable not set", file=sys.stderr)
        print("or provide --page-id argument", file=sys.stderr)
        sys.exit(1)

    # Initialize Notion client with latest API version
    notion = Client(
        auth=api_token,
        notion_version="2025-09-03",
    )

    try:
        # Fetch page content
        content = get_page_content(notion, page_id)

        # Determine image directory
        image_dir = None
        if not args.no_images:
            if args.images_dir:
                # Use explicitly provided images directory
                image_dir = args.images_dir
            elif args.output:
                # Default: images/ subdirectory relative to output file
                image_dir = args.output.parent / "images"

        # Format output
        if args.format == "json":
            output = json.dumps(content, indent=2)
        else:  # markdown
            title = get_page_title(content["page"])
            markdown_content = blocks_to_markdown(content["blocks"], image_dir=image_dir)
            output = f"# {title}\n\n{markdown_content}"

        # Write output
        if args.output:
            args.output.write_text(output)
            print(f"Documentation saved to {args.output}", file=sys.stderr)
            if image_dir and image_dir.exists():
                image_count = len(list(image_dir.glob("*")))
                print(f"Downloaded {image_count} image(s) to {image_dir}", file=sys.stderr)
        else:
            print(output)

    except Exception as e:
        print(f"Error fetching Notion page: {e}", file=sys.stderr)
        sys.exit(1)


if __name__ == "__main__":
    main()
