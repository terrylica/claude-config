#!/usr/bin/env python3
"""
Simple lunch break validation - use existing database.
"""

import sys
from pathlib import Path

sys.path.insert(0, str(Path(__file__).parent.parent / "src"))

import pandas as pd
from exness_data_preprocess import ExnessDataProcessor

# Use the test database we just created
test_dir = Path("/var/folders/f4/yr36gs0j7gb46m_lcdc6tr2h0000gn/T/lunch_final_verify_g_b_bc4g")

processor = ExnessDataProcessor(base_dir=test_dir)

print("="*70)
print("TOKYO LUNCH BREAK VALIDATION")
print("="*70)

# Test 1: Tokyo lunch (11:30-12:29 JST, should be 0)
print("\n[1] Tokyo Lunch (11:30-12:29 JST = 02:30-03:29 UTC)")
start = pd.Timestamp("2024-08-05 02:30:00", tz="UTC")
end = pd.Timestamp("2024-08-05 03:29:00", tz="UTC")
df = processor.query_ohlc("EURUSD", "1m", start, end)
lunch_flags = df["is_xtks_session"].sum()
print(f"    Session flags: {lunch_flags}/{len(df)} (should be 0)")
if lunch_flags == 0:
    print("    ✅ PASS")
else:
    print(f"    ❌ FAIL")
    sys.exit(1)

# Test 2: Tokyo morning (should be >0)
print("\n[2] Tokyo Morning (9:00-11:29 JST = 00:00-02:29 UTC)")
start = pd.Timestamp("2024-08-05 00:00:00", tz="UTC")
end = pd.Timestamp("2024-08-05 02:29:00", tz="UTC")
df = processor.query_ohlc("EURUSD", "1m", start, end)
morning_flags = df["is_xtks_session"].sum()
print(f"    Session flags: {morning_flags}/{len(df)} (should be >0)")
if morning_flags > 0:
    print(f"    ✅ PASS ({morning_flags} correctly flagged)")
else:
    print(f"    ❌ FAIL - morning hours not detected!")
    sys.exit(1)

# Test 3: Tokyo afternoon (12:30-15:00 JST = 03:30-06:00 UTC)
print("\n[3] Tokyo Afternoon (12:30-15:00 JST = 03:30-06:00 UTC)")
start = pd.Timestamp("2024-08-05 03:30:00", tz="UTC")
end = pd.Timestamp("2024-08-05 06:00:00", tz="UTC")
df = processor.query_ohlc("EURUSD", "1m", start, end)
afternoon_flags = df["is_xtks_session"].sum()
print(f"    Session flags: {afternoon_flags}/{len(df)} (should be >0)")
if afternoon_flags > 0:
    print(f"    ✅ PASS ({afternoon_flags} correctly flagged)")
else:
    print(f"    ❌ FAIL - afternoon hours not detected!")
    sys.exit(1)

print("\n" + "="*70)
print("✅ ALL TESTS PASSED")
print("="*70)
