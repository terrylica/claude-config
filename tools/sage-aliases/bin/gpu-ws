#!/bin/bash
# GPU Workstation Connection - Universal Access Command
# Part of SAGE Aliases Tool - ~/.claude/tools/sage-aliases/

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Determine tool directory based on installation location
if [[ "$SCRIPT_DIR" == *"/.local/bin" ]]; then
    # Installed via installer - use fixed path
    TOOL_DIR="$HOME/.claude/tools/sage-aliases"
else
    # Running from workspace - use relative path
    TOOL_DIR="$(dirname "$SCRIPT_DIR")"
fi

# Source GPU workstation aliases to get access to functions
source "$TOOL_DIR/aliases/gpu-workstation.sh"

# If no arguments, connect to GPU workstation
if [ $# -eq 0 ]; then
    exec ssh zerotier-remote
fi

# Handle specific commands
case "$1" in
    "status")
        ssh zerotier-remote "hostname && nvidia-smi --query-gpu=gpu_name,memory.used,memory.total --format=csv,noheader,nounits"
        ;;
    "check")
        ping -c 2 172.25.253.142 && echo "âœ… GPU workstation reachable"
        ;;
    "claude")
        exec ssh zerotier-remote -t "cd ~/eon/nt && export PATH=~/.npm-global/bin:\$PATH && claude"
        ;;
    "sage")
        exec ssh zerotier-remote -t "cd ~/eon/nt && echo \"SAGE Development - GPU Environment (RTX 4090)\" && export PATH=~/.npm-global/bin:\$PATH && nvidia-smi --query-gpu=gpu_name,memory.used,memory.total --format=csv,noheader,nounits && claude"
        ;;
    "dev")
        echo "ðŸš€ Starting GPU development session..."
        ping -c 2 172.25.253.142 && echo "âœ… GPU workstation reachable"
        ssh zerotier-remote "hostname && nvidia-smi --query-gpu=gpu_name,memory.used,memory.total --format=csv,noheader,nounits"
        exec ssh zerotier-remote -t "cd ~/eon/nt && export PATH=~/.npm-global/bin:\$PATH && claude"
        ;;
    "help"|"-h"|"--help")
        echo "GPU Workstation Universal Access Tool

Usage: gpu [command]

Commands:
  (no args)    Connect to GPU workstation via SSH
  status       Show GPU hardware status
  check        Test connectivity
  claude       Start Claude Code on GPU workstation  
  sage         Start SAGE development session with GPU status
  dev          Complete development startup (check + status + claude)
  help         Show this help message

Examples:
  gpu                    # SSH to GPU workstation
  gpu status             # Check GPU memory and utilization
  gpu claude             # Start Claude Code development session
  gpu sage               # Start SAGE development with GPU monitoring
  gpu dev                # Full development session startup

Part of SAGE Aliases Tool - ~/.claude/tools/sage-aliases/"
        ;;
    *)
        echo "Unknown command: $1"
        echo "Use 'gpu help' for available commands"
        exit 1
        ;;
esac