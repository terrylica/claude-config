#!/bin/bash
# Claude Code Workspace - Complete Tool Installation Script
# Installs ALL workspace tools to ~/.local/bin for universal access

set -euo pipefail

CLAUDE_DIR="${HOME}/.claude"
BIN_DIR="${HOME}/.local/bin"
BACKUP_DIR=""

handle_failure() {
    echo
    echo "âŒ Installation failed! Rolling back changes..."
    if [[ -n "$BACKUP_DIR" && -d "$BACKUP_DIR" ]]; then
        # Restore backed up files
        if ls "$BACKUP_DIR"/* >/dev/null 2>&1; then
            cp "$BACKUP_DIR"/* "$BIN_DIR/" 2>/dev/null || true
            echo "âœ… Restored previous files from backup"
        fi
        rm -rf "$BACKUP_DIR"
    fi
    echo "ğŸ”§ Please check the error above and try again"
    exit 1
}

main() {
    echo "ğŸ”§ Claude Code Workspace - Complete Tool Installer v1.1"
    echo "======================================================"
    echo
    echo "ğŸ’¡ This installer sets up ALL workspace tools:"
    echo "   â€¢ SAGE development tools (sage-dev, sage-sync, sage-status, gpu-ws)"
    echo "   â€¢ GFM Link Checker (gfm-check)"
    echo "   â€¢ CNS Notification System (cns-notify)"
    echo "   â€¢ Tmux Session Management (tmux-session, tmux-list, tmux-kill)"
    echo "   â€¢ Configures PATH automatically for global access"
    echo
    echo "ğŸ¯ After installation, all commands work from any directory!"
    echo
    
    # Create backup directory for rollback capability
    BACKUP_DIR=$(mktemp -d "${TMPDIR:-/tmp}/claude-install-backup.XXXXXX")
    trap 'handle_failure' ERR
    
    validate_workspace
    setup_directories
    install_sage_tools
    install_gfm_checker
    install_cns_tools
    install_tmux_tools
    setup_path
    verify_installation
    
    # Cleanup backup on success
    rm -rf "$BACKUP_DIR"
    
    echo
    echo "ğŸ‰ Complete Installation Finished!"
    echo
    echo "ğŸ“š Available Tools:"
    echo "   SAGE Development:"
    echo "     sage-dev     - Development environment launcher"
    echo "     sage-sync    - Workspace/session sync tool"
    echo "     sage-status  - Infrastructure health check"
    echo "     gpu-ws       - GPU workstation access"
    echo
    echo "   Documentation & Quality:"
    echo "     gfm-check    - Markdown link integrity checker"
    echo
    echo "   System Tools:"
    echo "     cns-notify   - Audio notification system"
    echo "     tmux-session - Session management"
    echo "     tmux-list    - List active sessions"
    echo "     tmux-kill    - Kill sessions"
    echo
    echo "ğŸ’¡ All commands are now available globally!"
    echo "   Restart your shell or run: source ~/.zshrc"
}

validate_workspace() {
    echo "ğŸ” Step 1: Validating Claude Code Workspace"
    echo "   Checking if workspace is properly set up..."
    echo
    
    if [[ ! -d "$CLAUDE_DIR" ]]; then
        echo "âŒ Claude Code workspace not found at: $CLAUDE_DIR"
        echo
        echo "ğŸš¨ Please clone the workspace first:"
        echo "   git clone <repo-url> ~/.claude"
        echo
        exit 1
    fi
    
    local tool_dirs=("tools/sage-aliases" "tools/gfm-link-checker" "automation/cns" "tmux")
    local missing_tools=()
    
    for tool_dir in "${tool_dirs[@]}"; do
        if [[ ! -d "$CLAUDE_DIR/$tool_dir" ]]; then
            missing_tools+=("$tool_dir")
        fi
    done
    
    if [[ ${#missing_tools[@]} -gt 0 ]]; then
        echo "âš ï¸  Some tools are missing from workspace:"
        for missing in "${missing_tools[@]}"; do
            echo "   - $missing"
        done
        echo
        echo "ğŸ’¡ These tools will be skipped during installation."
        echo
    fi
    
    echo "âœ… Claude Code workspace validated"
    echo
}

setup_directories() {
    echo "ğŸ“ Step 2: Setting Up Installation Directories"
    echo "   Creating ~/.local/bin for global command access..."
    echo
    
    if [[ -d "$BIN_DIR" ]]; then
        echo "âœ… Directory already exists: $BIN_DIR"
    else
        mkdir -p "$BIN_DIR"
        echo "âœ… Created directory: $BIN_DIR"
    fi
    echo
}

install_sage_tools() {
    echo "ğŸ§  Step 3: Installing SAGE Development Tools"
    echo "   Installing comprehensive SAGE development suite..."
    echo
    
    if [[ ! -d "$CLAUDE_DIR/tools/sage-aliases/bin" ]]; then
        echo "âš ï¸  SAGE tools not found, skipping..."
        echo
        return
    fi
    
    local sage_commands=("sage-dev" "sage-sync" "sage-status" "gpu-ws")
    local installed=0
    
    for cmd in "${sage_commands[@]}"; do
        if [[ -f "$CLAUDE_DIR/tools/sage-aliases/bin/$cmd" ]]; then
            # Backup existing file if present
            [[ -f "$BIN_DIR/$cmd" ]] && cp "$BIN_DIR/$cmd" "$BACKUP_DIR/$cmd.bak" 2>/dev/null || true
            cp "$CLAUDE_DIR/tools/sage-aliases/bin/$cmd" "$BIN_DIR/$cmd"
            chmod +x "$BIN_DIR/$cmd"
            echo "   âœ… $cmd: Installed"
            ((installed++))
        fi
    done
    
    echo "   ğŸ“Š SAGE tools: $installed/${#sage_commands[@]} installed"
    echo
}

install_gfm_checker() {
    echo "ğŸ“ Step 4: Installing GFM Link Checker"
    echo "   Installing markdown link integrity validation..."
    echo
    
    if [[ ! -f "$CLAUDE_DIR/tools/gfm-link-checker/bin/gfm-check" ]]; then
        echo "âš ï¸  GFM checker not found, skipping..."
        echo
        return
    fi
    
    [[ -f "$BIN_DIR/gfm-check" ]] && cp "$BIN_DIR/gfm-check" "$BACKUP_DIR/gfm-check.bak" 2>/dev/null || true
    cp "$CLAUDE_DIR/tools/gfm-link-checker/bin/gfm-check" "$BIN_DIR/gfm-check"
    chmod +x "$BIN_DIR/gfm-check"
    echo "   âœ… gfm-check: Installed"
    echo
}

install_cns_tools() {
    echo "ğŸ”Š Step 5: Installing CNS Notification System"
    echo "   Installing audio notification tools..."
    echo
    
    # CNS notify is in the global bin directory
    if [[ -f "$CLAUDE_DIR/bin/cns-notify" ]]; then
        [[ -f "$BIN_DIR/cns-notify" ]] && cp "$BIN_DIR/cns-notify" "$BACKUP_DIR/cns-notify.bak" 2>/dev/null || true
        cp "$CLAUDE_DIR/bin/cns-notify" "$BIN_DIR/cns-notify"
        chmod +x "$BIN_DIR/cns-notify"
        echo "   âœ… cns-notify: Installed"
    else
        echo "âš ï¸  CNS tools not found, skipping..."
    fi
    echo
}

install_tmux_tools() {
    echo "ğŸ’» Step 6: Installing Tmux Session Management"
    echo "   Installing terminal session management tools..."
    echo
    
    if [[ ! -d "$CLAUDE_DIR/tmux/bin" ]]; then
        echo "âš ï¸  Tmux tools not found, skipping..."
        echo
        return
    fi
    
    local tmux_commands=("tmux-session" "tmux-list" "tmux-kill")
    local installed=0
    
    for cmd in "${tmux_commands[@]}"; do
        if [[ -f "$CLAUDE_DIR/tmux/bin/$cmd" ]]; then
            [[ -f "$BIN_DIR/$cmd" ]] && cp "$BIN_DIR/$cmd" "$BACKUP_DIR/$cmd.bak" 2>/dev/null || true
            cp "$CLAUDE_DIR/tmux/bin/$cmd" "$BIN_DIR/$cmd"
            chmod +x "$BIN_DIR/$cmd"
            echo "   âœ… $cmd: Installed"
            ((installed++))
        fi
    done
    
    echo "   ğŸ“Š Tmux tools: $installed/${#tmux_commands[@]} installed"
    echo
}

setup_path() {
    echo "ğŸ›¤ï¸  Step 7: Configuring PATH for Global Access"
    echo "   Ensuring ~/.local/bin is in your PATH..."
    echo
    
    if [[ ":$PATH:" == *":$HOME/.local/bin:"* ]]; then
        echo "âœ… PATH already includes ~/.local/bin"
        echo
        return
    fi
    
    local shell_config=""
    local shell_name=""
    
    if [[ -n "${ZSH_VERSION:-}" ]]; then
        shell_config="$HOME/.zshrc"
        shell_name="zsh"
    elif [[ -n "${BASH_VERSION:-}" ]]; then
        shell_config="$HOME/.bashrc"
        shell_name="bash"
    else
        echo "âš ï¸  Unknown shell - please manually add ~/.local/bin to PATH"
        echo
        return
    fi
    
    echo "ğŸ”§ Adding ~/.local/bin to PATH in $shell_config"
    echo '' >> "$shell_config"
    echo '# Claude Code Tools - Added by install-all-tools' >> "$shell_config"
    echo 'export PATH="$HOME/.local/bin:$PATH"' >> "$shell_config"
    
    echo "âœ… PATH configured for $shell_name"
    echo
}

verify_installation() {
    echo "ğŸ” Step 8: Verifying Complete Installation"
    echo "   Testing all installed tools..."
    echo
    
    local all_commands=(
        "sage-dev" "sage-sync" "sage-status" "gpu-ws"
        "gfm-check" "cns-notify" 
        "tmux-session" "tmux-list" "tmux-kill"
    )
    
    local working=0
    local total=0
    
    for cmd in "${all_commands[@]}"; do
        if [[ -x "$BIN_DIR/$cmd" ]]; then
            # Test command actually executes
            if "$BIN_DIR/$cmd" --help >/dev/null 2>&1 || "$BIN_DIR/$cmd" -h >/dev/null 2>&1; then
                echo "   âœ… $cmd: Working"
                ((working++))
            else
                echo "   âš ï¸  $cmd: Installed but not functional"
            fi
        else
            echo "   âš ï¸  $cmd: Not installed (tool may be missing from workspace)"
        fi
        ((total++))
    done
    
    echo
    echo "ğŸ“Š Installation Summary: $working/$total tools available"
    
    if [[ $working -gt 0 ]]; then
        echo "ğŸ¯ Installation successful!"
        if [[ ":$PATH:" == *":$HOME/.local/bin:"* ]]; then
            echo "ğŸš€ Commands are immediately available!"
        else
            echo "ğŸ”„ Commands will be available after shell restart"
        fi
    else
        echo "âŒ No tools were installed - check workspace integrity"
        return 1
    fi
}

main "$@"